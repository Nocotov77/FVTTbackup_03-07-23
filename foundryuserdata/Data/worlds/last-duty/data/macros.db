{"name":"Конец хода","type":"script","scope":"global","author":"7FLOSVa6De7MrSry","img":"icons/skills/melee/weapons-crossed-daggers-orange.webp","command":"/*\nAuthor: willisrocks\nDescription: \n\nЗавершает текущий ход актеров боевым столкновением. Полезно, когда вы не используете свой боевой трекер. и хотите закончить ход с панели быстрого доступа. Если пользователь является гейм-мастером, он всегда будет завершать текущий ход. \nДля игроков это только закончится ход, когда текущий актер в порядке хода принадлежит вам. На основе работы пользователя Reddit serrag97: https://www.reddit.com/r/FoundryVTT/comments/j1b8gs/next_turn_shortcut/\n*/\n\n// check if the user is a GM\nconst isGM = game.user.isGM;\n// check if the user owns the combatant whose turn it is\nconst isOwner = game.combat.combatant.isOwner;\n\nif (isGM || isOwner) {\n  game.combat.nextTurn();\n} else {\n  ui.notifications.info(\"Как игрок вы можете только продвигать свой ход\");\n}","flags":{"core":{"sourceId":"Macro.2hjDVnk5dbuCSuH6"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672482529405,"modifiedTime":1678115543753,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":125000,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"10NrFZEyT1CH1hqE"}
{"name":"Don't Mark Dead","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/svg/aura.svg","scope":"global","command":"/**\n*  This macro will make this NPC show as Unconscious (or whatever is the first stage).\n*  This is meant for people that use the \"NPCs die immediately\" setting but still want some NPCs to not be shown as dead.\n*  Use it again to toggle it.\n*/\n\nfor (let e of canvas.tokens.controlled) {\n\tlet hasAlive = !e.document.getFlag(\"healthEstimate\", \"treatAsPC\")\n\te.document.setFlag(\"healthEstimate\", \"treatAsPC\", hasAlive)\n}","folder":"ZHrGV0uxoDuYnV0i","sort":100000,"flags":{"core":{"sourceId":"Macro.bCMlVEb7wx14ACIB"},"advanced-macros":{"runAsGM":false}},"ownership":{"default":0,"oPuS5iW18dRDcW4r":3,"7FLOSVa6De7MrSry":3},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1678115521792,"modifiedTime":1678115521844,"lastModifiedBy":"7FLOSVa6De7MrSry"},"_id":"4q6UXIg6WC9vVTe5"}
{"name":"Зрение","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/magic/perception/eye-ringed-glow-angry-large-teal.webp","scope":"global","command":"// Макрос для Foundry, который позволяет пользователю настраивать параметры обзора и освещения своего токена. \n\nlet applyChanges = false;\nnew Dialog({\n  title: `Конфигурация зрения токена`,\n  content: `\n    <form>\n      <div class=\"form-group\">\n        <label>Тип зрения:</label>\n        <select id=\"vision-type\" name=\"vision-type\">\n          <option value=\"nochange\">Без изменений</option>\n          <option value=\"dim0\">Зрение</option>\n          <option value=\"dim30\">Ночное зрение (30 футов)</option>\n          <option value=\"dim60\">Ночное зрение (60 футов)</option>\n          <option value=\"dim90\">Ночное зрение (90 футов)</option>\n          <option value=\"dim120\">Ночное зрение (120 футов)</option>\n          <option value=\"dim150\">Ночное зрение (150 футов)</option>\n          <option value=\"dim180\">Ночное зрение (180 футов)</option>\n          <option value=\"bright120\">Дьявольское зрение (Колдун)</option>\n        </select>\n      </div>\n      <div class=\"form-group\">\n        <label>Источник света:</label>\n        <select id=\"light-source\" name=\"light-source\">\n          <option value=\"nochange\">Без изменений</option>\n          <option value=\"none\">Нет</option>\n          <option value=\"candle\">Свеча</option>\n          <option value=\"lamp\">Лампа</option>\n          <option value=\"bullseye\">Фонарь потайной</option>\n          <option value=\"hooded-dim\">Фонарь (обычный — приглушённый)</option>\n          <option value=\"hooded-bright\">Фонарь (обычный — яркий)</option>\n          <option value=\"light\">Свет (Фокус)</option>\n          <option value=\"torch\">Факел</option>\n          <option value=\"moon-touched\">Осенённое луной оружие</option>\n        </select>\n      </div>\n    </form>\n    `,\n  buttons: {\n    yes: {\n      icon: \"<i class='fas fa-check'></i>\",\n      label: `Применить`,\n      callback: () => applyChanges = true\n    },\n    no: {\n      icon: \"<i class='fas fa-times'></i>\",\n      label: `Отменить`\n    },\n  },\n  default: \"yes\",\n  close: html => {\n    if (applyChanges) {\n      let updates = [];\n      for ( let token of canvas.tokens.controlled ) {\n        let visionType = html.find('[name=\"vision-type\"]')[0].value || \"none\";\n        let lightSource = html.find('[name=\"light-source\"]')[0].value || \"none\";\n        let dimSight = 0;\n        let brightSight = 0;\n        let dimLight = 0;\n        let brightLight = 0;\n        let lightAngle = 360;\n        let lockRotation = token.data.lockRotation;\n        let lightAnimation = token.data.light.animation;\n        let lightAlpha = token.data.light.alpha;\n        let lightColor = token.data.light.color;\n        const colorFire = \"#f8c377\";\n        const colorWhite = \"#ffffff\";\n        const colorMoonGlow = \"#f4f1c9\";\n        // Get Vision Type Values\n        switch (visionType) {\n          case \"dim0\":\n            dimSight = 0;\n            brightSight = 0;\n            break;\n          case \"dim30\":\n            dimSight = 30;\n            brightSight = 0;\n            break;\n          case \"dim60\":\n            dimSight = 60;\n            brightSight = 0;\n            break;\n          case \"dim90\":\n            dimSight = 90;\n            brightSight = 0;\n            break;\n          case \"dim120\":\n            dimSight = 120;\n            brightSight = 0;\n            break;\n          case \"dim150\":\n            dimSight = 150;\n            brightSight = 0;\n            break;\n          case \"dim180\":\n            dimSight = 180;\n            brightSight = 0;\n            break;\n          case \"bright120\":\n            dimSight = 0;\n            brightSight= 120;\n            break;\n          case \"nochange\":\n          default:\n            dimSight = token.data.dimSight;\n            brightSight = token.data.brightSight;\n        }\n        // Get Light Source Values\n        switch (lightSource) {\n          case \"none\":\n            dimLight = 0;\n            brightLight = 0;\n            lightAnimation = {type: \"none\"};\n            break;\n          case \"candle\":\n            dimLight = 10;\n            brightLight = 5;\n            lightAnimation = {type: \"torch\", speed: 2, intensity: 2};\n            lightColor = colorFire;\n            lightAlpha = 0.15;\n            break;\n          case \"lamp\":\n            dimLight = 45;\n            brightLight = 15;\n            lightAnimation = {type: \"torch\", speed: 2, intensity: 2};\n            lightColor = colorFire;\n            lightAlpha = 0.15;\n            break;\n          case \"bullseye\":\n            dimLight = 120;\n            brightLight = 60;\n            lockRotation = false;\n            lightAngle = 52.5;\n            lightAnimation = {type: \"torch\", speed: 2, intensity: 2};\n            lightColor = colorFire;\n            lightAlpha = 0.15;\n            break;\n          case \"hooded-dim\":\n            dimLight = 5;\n            brightLight = 0;\n            lightAnimation = {type: \"torch\", speed: 2, intensity: 2};\n            lightColor = colorFire;\n            lightAlpha = 0.15;\n            break;\n          case \"hooded-bright\":\n            dimLight = 60;\n            brightLight = 30;\n            lightAnimation = {type: \"torch\", speed: 2, intensity: 2};\n            lightColor = colorFire;\n            lightAlpha = 0.15;\n            break;\n          case \"light\":\n            dimLight = 40;\n            brightLight = 20;\n            lightAnimation = {type: \"none\"};\n            lightColor = colorWhite;\n            lightAlpha = 0.15;\n            break;\n          case \"torch\":\n            dimLight = 40;\n            brightLight = 20;\n            lightAnimation = {type: \"torch\", speed: 2, intensity: 2};\n            lightColor = colorFire;\n            lightAlpha = 0.15;\n            break;\n          case \"moon-touched\":\n            dimLight = 30;\n            brightLight = 15;\n            lightAnimation = {type: \"none\"};\n            lightColor = colorMoonGlow;\n            break;\n          case \"nochange\":\n          default:\n            dimLight = token.data.light.dim;\n            brightLight = token.data.light.bright;\n            lightAngle = token.data.light.angle;\n            lockRotation = token.data.lockRotation;\n            lightAnimation = token.data.light.animation;\n            lightAlpha = token.data.light.alpha;\n            lightColor = token.data.light.color;\n        }\n        // Update Token\n        updates.push({\n          _id: token.id,\n          vision: true,\n          dimSight: dimSight,\n          brightSight: brightSight,\n          \"light.dim\": dimLight,\n          \"light.bright\":  brightLight,\n          \"light.angle\": lightAngle,\n          lockRotation: lockRotation,\n          \"light.animation\": lightAnimation,\n          \"light.alpha\": lightAlpha,\n          \"light.color\": lightColor\n        });\n      }\n      canvas.scene.updateEmbeddedDocuments(\"Token\", updates);\n    }\n  }\n}).render(true);","flags":{"scene-packer":{"hash":"5188e6ec28231171e3ec1d1964a7706234303ad1","sourceId":"Macro.6N0B0ZXbO2oeLqX2"},"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"exportSource":{"world":"tyrany","system":"dnd5e","coreVersion":"10.290","systemVersion":"2.0.3"},"core":{"sourceId":"Macro.mye13wO0ulyTXJwN"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1667586201333,"modifiedTime":1678115355917,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Pz08NbrXltlABR9O","sort":100000,"ownership":{"default":0,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"CWTyU3S4KWICBPvj"}
{"name":"Справочник","type":"script","author":"7FLOSVa6De7MrSry","img":"modules/laaru-dnd5-hw/assets/icons/feat/phb-skilled.webp","scope":"global","command":"// Макрос для Foundry, который позволяет пользователю открыть справочник Phenomen'a. \nnew Dialog({\n title: \"Справочник\",\n content: `<iframe id=\"jsdos\" src=\"https://5e.ruleplaying.com/\" width=\"100%\" height=\"100%\"></iframe>`,\n buttons: {},\n render: html => {\n        html.style.flex = \"100%\";\n        html.querySelector(\"#jsdos\").focus();\n     }\n}, { height: 600, width: 800, jQuery: false }).render(true);","flags":{"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.ufppKNOT0u4ygCXI"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672483532195,"modifiedTime":1678115543753,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":112500,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"J0vkDmnGb9AUDveJ"}
{"name":"Шепот","type":"script","author":"7FLOSVa6De7MrSry","img":"https://cdn-icons-png.flaticon.com/512/2755/2755344.png","scope":"global","command":"/** \n * Предоставляет диалог для шепота определенным игрокам. Если у вас выбраны токены, по умолчанию они автоматически попытаются прошептать этим игрокам.\n * @Author: Nelson#3570\n */\n\nlet applyChanges = false;\n\nlet users = game.users.filter(user => user.active);\nlet checkOptions = \"\"\nlet playerTokenIds = users.map(u => u.character?.id).filter(id => id !== undefined);\nlet selectedPlayerIds = canvas.tokens.controlled.map(token => {\n  if (playerTokenIds.includes(token.actor.id)) return token.actor.id;\n});\n\n// Build checkbox list for all active players\nusers.forEach(user => {\n  let checked = !!user.character && selectedPlayerIds.includes(user.character.id) && 'checked';\n  checkOptions+=`\n    <br>\n    <input type=\"checkbox\" name=\"${user.id}\" id=\"${user.id}\" value=\"${user.name}\" ${checked}>\\n\n    <label for=\"${user.id}\">${user.name}</label>\n  `\n});\n\nnew Dialog({\n  title:\"Шёпот\",\n  content:`Шептать: ${checkOptions} <br>\n    <label for=\"message\">Сообщение:</label>\n    <textarea id=\"message\" name=\"message\" rows=\"4\" cols=\"50\"></textarea><br>`,\n  buttons:{\n    whisper:{   \n      label:\"Whisper\",\n      callback: (html) => createMessage(html)\n    }\n  }\n}).render(true);\n\nfunction createMessage(html) {\n  var targets = [];\n  // build list of selected players ids for whispers target\n  for ( let user of users ) {\n    if (html.find('[name=\"'+user.id+'\"]')[0].checked){\n      applyChanges=true;\n      targets.push(user.id);\n    }\n    var messageText = html.find('[name=\"message\"]')[0].value\n  }\nif(!applyChanges)return;\n  ChatMessage.create({\n    content: messageText,\n    whisper: targets\n  });\n}","flags":{"advanced-macros":{"runAsGM":false},"exportSource":{"world":"demo-mad-mage","system":"dnd5e","coreVersion":"10.288","systemVersion":"2.0.3"},"core":{"sourceId":"Macro.yri0AA1nqi7s8xMu"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672485830656,"modifiedTime":1678115543753,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":106250,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"QtOIjggP6zbiYbqI"}
{"name":"Случайные броски характеристик","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/sundries/gaming/dice-pair-white-green.webp","scope":"global","command":"/**\n * Генерирует характеристики персонажа и выводит результат в виде таблицы.\n * Author: @Kekilla#7036 & KrishMero1792\n */\n \n// Formula for rolling \nconst statString = '4d6kh3';\n\n// times to roll those stats\nconst numRolls = 6;\n\n\n//////////////////////////////////////////\n// Don't touch anything below this line //\n//////////////////////////////////////////\nconst stats = Array(numRolls).fill(0).map(e=>new Roll(statString).evaluate({async: false}));\n\nconst rollData = stats[0].dice[0];\nconst {faces, values: keptRolls, results: rolls} = rollData;\nconst totalAverage = (faces/2 + 1) * keptRolls.length;\nconst totalDeviation = faces/2;\nconst totalLow = Math.ceil(totalAverage - totalDeviation);\nconst totalHigh = Math.ceil(totalAverage + totalDeviation);\n\nconst header = rolls.map((roll, index) => `<th>D${index + 1}</th>`).join('');\n\nlet tableRows = '';\nlet finalSum = 0;\nfor(let {terms, total} of stats) {\n  tableRows += `<tr style=\"text-align:center\">`;\n  tableRows += terms[0].results.map(({result, discarded}) => `<td style=\"${colorSetter(result, 1, faces, discarded)}\">${result}</td>`).join('');\n  tableRows += `<td style=\"border-left:1px solid #000; ${colorSetter(total, totalLow, totalHigh)}\">${total}</td></tr>`;\n  finalSum += total;\n}\n\nconst colspan = `colspan=\"${rolls.length + 1}\"`;\nconst center = `text-align:center;`;\n\nlet content = `\n  <table>\n    <tr>\n      <td ${colspan}><h2 style=\"margin-bottom:0; ${center}\">Значения характеристик</h2>\n      <div style=\"margin-bottom: 0.5rem; ${center}\">${statString} были проброшены ${numRolls} раз.</div></td>\n    </tr>\n    <tr style=\"${center} border-bottom:1px solid #000\">\n      ${header}\n      <th style=\"border-left:1px solid #000\">Итог</th>\n    </tr>\n    ${tableRows}\n    <tr style=\"border-top: 1px solid #000\">\n      <th colspan=\"${rolls.length}\" style=\"${center}\">Финальная сумма:</th>\n      <th style=\"${center}\">${finalSum}</th>\n    </tr>\n  </table>\n`;\n\n\nChatMessage.create({content});\n\nfunction colorSetter(number,low,high, discarded)\n{\n  if(discarded === true) return 'text-decoration:line-through;color:gray';\n  if(number <= low) return 'color:red';\n  if(number >= high) return 'color:green';\n  return '';\n}","flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-roll.cj0Sm0kWnHx11nFR"},"exportSource":{"world":"novaya-sistema","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"advanced-macros":{"runAsGM":false}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672485699440,"modifiedTime":1680102644129,"lastModifiedBy":"xZLGejI93oPA29F6"},"folder":"Ro21mwVVlgn3Oi16","sort":100000,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"SYJr64WkworiYQGw"}
{"name":"Картинка в чат или шепот","type":"script","author":"7FLOSVa6De7MrSry","img":"https://cdn.iconscout.com/icon/free/png-256/send-mail-69-667875.png","scope":"global","command":"// Макрос для Foundry, который позволяет отправить картинку (из ссылки) определённому игроку или всем игрокам. Причем если в Чат, то картинка будет приватной, а если как Всплывающее изображение, то будет показано всем. \nconst wait = (delay) => new Promise((resolve) => setTimeout(resolve, delay));\nasync function imageMessage(html, mode) {\n    const url = html.find(\"[name=url]\")[0].value;\n    if (url === \"\") {\n        return;\n    }\n    if (mode == \"chat\") {\n        const messageContent = `<img src=\"${url}\" />`;\n        const checked = html.find(\"[name=whisper]\")[0].checked;\n        if(!checked) {\n            await ChatMessage.create({content: messageContent});\n            return;\n        }\n        const playerId = html.find(\"[name=player]\")[0].value;\n        const playerName = game.users.get(playerId).data.name;\n        await ChatMessage.create({content: messageContent, whisper: ChatMessage.getWhisperRecipients(playerName)})\n    }\n    if (mode == \"popout\"){\n        const popout = new ImagePopout(url).render(true);\n        popout.shareImage();\n    }\n\n}\n(async () => {\n    let dialogOptions = game.users.filter(u => u.data.role < 3).map(u => `<option value=${u.id}> ${u.data.name} </option>`).join(``);\n    \n    \n    let dialogContent = `\n                        <div><h2>Вставьте ссылку на изображение:</h2><div>\n                        <div>URL: <input name=\"url\" style=\"width:350px\"/></div>\n                        <div><i>если изображение взято из Интернета, не забудьте включить http(s):// в url</i></div>\n                        <div>Шептать игроку?<input name=\"whisper\" type=\"checkbox\"/></div>\n                        <div\">Имя игрока:<select name=\"player\" disabled>${dialogOptions}</select></div>\n                        `;\n    let d = new Dialog({\n        title: \"Image to Chat\",\n        content: dialogContent,\n        buttons: {\n            done: {\n                label: \"Отправить в чат!\",\n                callback: (html) => {\n                    imageMessage(html, \"chat\");\n                }\n            },\n            show: {\n                label: \"Показать как всплывающее изображение!\",\n                callback: (html) => {\n                    imageMessage(html, \"popout\");\n                }\n            }\n        },\n        default: \"done\"    \n    })\n    d.render(true)\n    await wait(50)\n    $(document).ready(function() {\n        $(\"[name=whisper]\").change(function () {\n            if($(\"[name=player]\").attr(\"disabled\")){\n                $(\"[name=player]\").removeAttr(\"disabled\")\n            }\n            else {\n               $(\"[name=player]\").attr(\"disabled\", true)  \n            }\n        });\n    });\n})();","flags":{"advanced-macros":{"runAsGM":false},"exportSource":{"world":"cm1_jes","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.fSyGEAXUVN12sTo1"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672486740754,"modifiedTime":1678115543753,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":101563,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"VCyObr0XPXysbhz5"}
{"name":"Портрет токена","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/environment/people/commoner.webp","scope":"global","command":"// Макрос для Foundry, который позволяет показать игрокам портрет выделенного токена. \ncanvas.tokens.updateAll(\n  token => ({ displayName : CONST.TOKEN_DISPLAY_MODES.HOVER }),\n  token => token._controlled,\n);\n\nconst popout = new ImagePopout(canvas.tokens.controlled[0].actor.data.img).render(true);\npopout.shareImage();","flags":{"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.hLjBBjMSMCjdTMw6"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672485486112,"modifiedTime":1678115363757,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Pz08NbrXltlABR9O","sort":150000,"ownership":{"default":0,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"Wqg2P13RTZAkjj6v"}
{"name":"Проверка Расследования","type":"script","author":"7FLOSVa6De7MrSry","img":"https://i.imgur.com/VibZPwz.png","scope":"global","command":"//Проверка навыка. \n// Если у игрока несколько персонажей, необходимо выделить тот токен, за которого будет бросаться проверка.\nactor.rollSkill('inv');","flags":{"advanced-macros":{"runAsGM":false},"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.fSyGEAXUVN12sTo1"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672486924439,"modifiedTime":1678115543754,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":100196,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"XSVdnaf6sxSnkoRe"}
{"name":"Случайные ПЗ","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/magic/life/heart-area-circle-red-green.webp","scope":"global","command":"/**\n * Бросок/переброс со случайных значений Пунктов здоровья (по формулам) для выделенных токенов.\n * Author: Tielc#7191\n */\n\nconst tokens = canvas.tokens.controlled;\nlet choice = 0;\n\nif (tokens.length > 0){\n    tokens.forEach(rollHP);\n} else {\n    printMessage(\"No Tokens were selected\");\n}\n\nasync function rollHP(token, index){\n    let actor = token.actor;\n    let formula = actor.data.data.attributes.hp.formula;\n        \n    if (actor.data.type != \"npc\" || !formula) return;\n    \n    \nlet hp = (await new Roll(formula).roll()).total;\n    \n    await actor.update({\"data.attributes.hp.value\": hp, \"data.attributes.hp.max\": hp});\n    \n    printMessage('<h2>' + actor.data.name + '</h2><strong>HP:</strong> ' + actor.data.data.attributes.hp.value + '/' + actor.data.data.attributes.hp.max + '<span style=\"float:right\"><em>(' + token.data._id + ')</em></span>');\n}\n\nfunction printMessage(message){\n    let chatData = {\n        user : game.user._id,\n        content : message,\n        blind: true,\n        whisper : ChatMessage.getWhisperRecipients(\"GM\").map(u => u._id)\n    };\n\n    ChatMessage.create(chatData,{});    \n}","flags":{"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.fSyGEAXUVN12sTo1"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672487142137,"modifiedTime":1678115368475,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Pz08NbrXltlABR9O","sort":125000,"ownership":{"default":0,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"Z3TLPPZYKVWw9zfI"}
{"name":"Торговец редкостей","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/sundries/flags/banner-symbol-eye-purple.webp","scope":"global","command":"let applyChanges = false;\nconst tableCompendium = 'laaru-dnd5-hw.tables-extra';\nconst itemsCompendium = 'laaru-dnd5-hw.items';\nconst tableIds = {\n    'common': 'qPouW0h2zXtFo62a',\n    'uncommon': '6wcTUmhT2Hny9vNf',\n    'rare': 'WNZghiAhzqWMqkB4',\n    'veryrare': '587UR1kqHq9vw0gf',\n    'legenrady': 'jHMMeaB95As4WxLu',\n    'artifact': 'Smv2hyvMQh02YOrg',\n}\nconst priceByType = {\n    'common': '(1d6) * 10',\n    'uncommon': '(1d6+1) * 100',\n    'rare': '2d10 * 1000',\n    'veryrare': '(1d4+1) * 10000',\n    'legenrady': '2d6 * 25000',\n    'artifact': '2d6 * 250000',\n}\n\nconst textHeader = `\n<div class=\"table-draw\" data-table-id=\"LMrqEBBn3L1eegpc\">\n<ol class=\"table-results\">\n`;\nconst textFooter = `\n</ol>\n</div>\n`;\nconst itemTextHtml = ({ text, price, img, documentId, documentCollection }) => {\n    return `\n      <li class=\"table-result flexrow\" data-result-id=\"${documentId}}\" style=\"border-top: 1px solid var(--color-border-dark-tertiary); border-bottom: 0; position: relative; width: 100%; padding: 10px 0 0 0;\"\">\n        <img class=\"result-image\" src=\"${img}\">\n        <div class=\"result-text\" style=\"max-width: calc(100% - 44px)\">\n            <a\n                class=\"content-link\"\n                draggable=\"true\" style=\"max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block;\"\n                data-pack=\"${documentCollection}}\"\n                data-uuid=\"Compendium.${documentCollection}.${documentId}\"\n                data-id=\"${documentId}\">\n                    <i class=\"fas fa-suitcase\"></i>${text}\n            </a>\n        </div>\n      </li>\n      <li style=\"padding: 0 0 4px 0;\">\n        <div class=\"flavor-text\" style=\"padding-left: 40px;\"> за <strong>${price}</strong></div>\n      </li>\n`;\n}\n\nnew Dialog({\n    title: `Генератор торговца`,\n    content: `\n    <form>\n      <div class=\"form-group\">\n        <label for=\"count\">Количество предметов(число и формула броска):</label>\n        <input type=\"text\" id=\"shop-gen-count\" name=\"shop-gen-count\" value=\"1d6\" />   \n      </div>\n      <div class=\"form-group\">\n        <label>Редкость предмета:</label>\n        <select id=\"shop-gen-item-rarity\" name=\"shop-gen-item-rarity\">\n          <option value=\"common\">Обычный</option>\n          <option value=\"uncommon\">Необычный</option>\n          <option value=\"rare\">Редкий</option>\n          <option value=\"veryrare\">Крайне редкий</option>\n          <option value=\"legenrady\">Легендарный</option>\n          <option value=\"artifact\">Артефакт</option>\n        </select>\n      </div>\n      <div class=\"form-group\">\n        <label>Шепот себе:</label>\n        <input type=\"checkbox\" id=\"shop-gen-whisper\" name=\"shop-gen-whisper\" checked >\n      </div>\n    </form>\n    `,\n    buttons: {\n        yes: {\n            icon: \"<i class='fas fa-check'></i>\",\n            label: `Сгенерировать`,\n            callback: () => applyChanges = true\n        },\n        no: {\n            icon: \"<i class='fas fa-times'></i>\",\n            label: `Отмена`\n        },\n    },\n    default: \"yes\",\n    close: async html => {\n        let priceDice = '';\n        let rollTable = null;\n        let rollPrice = null;\n        let textAr = [];\n\n        if (applyChanges) {\n\n            const tablePack = game.packs.get(tableCompendium);\n            if (!tablePack.index.length) await tablePack.getIndex();\n\n            const count = html.find('[name=\"shop-gen-count\"]')[0].value || '1';\n            const type = html.find('[name=\"shop-gen-item-rarity\"]')[0].value || \"common\";\n            const whisper = html.find('[name=\"shop-gen-whisper\"]')[0].checked || false;\n            priceDice = priceByType[type];\n            rollTable = new Roll(count.toString());\n\n            await rollTable.evaluate();\n            let table = await tablePack.getDocument(tableIds[type]);\n\n            let draw = await table.drawMany(rollTable.total, { displayChat: false });\n            textAr = draw.results.map((item) => {\n                rollPrice = new Roll(priceDice);\n                let price = rollPrice.evaluate({async: false});\n\n                return itemTextHtml({\n                    ...item,\n                    price: `${price.total} ЗМ`\n                });\n\n\n            }).join('');\n\n            let chatData = {\n                user: game.user._id,\n                speaker: ChatMessage.getSpeaker(),\n                content: textHeader + textAr + textFooter,\n            };\n            if (whisper) {\n                chatData.whisper = ChatMessage.getWhisperRecipients(\"GM\");\n            }\n              ChatMessage.create(chatData, {});\n        }\n    }\n}).render(true);","flags":{"scene-packer":{"hash":"ae031b26bec696850c882d05540f6177e6fd5aaa","sourceId":"Macro.e00zRTa1QkfFgvot"},"combat-utility-belt":{"macroTrigger":""},"advanced-macros":{"runAsGM":false},"exportSource":{"world":"tyranny-dev","system":"dnd5e","coreVersion":"10.291","systemVersion":"2.0.3"},"core":{"sourceId":"Macro.zTQcAR35R2r30R50"}},"ownership":{"default":0,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1674748075638,"modifiedTime":1678115456029,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Pz08NbrXltlABR9O","sort":112500,"_id":"ZgF4IUCUVmOzPjhC"}
{"name":"Output Estimates: Hide Names","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/svg/cowled.svg","scope":"global","command":"/**\n*  This macro will hide the Health Estimate from selected tokens.\n*/\n\nfor (let e of canvas.tokens.controlled) {\n\tlet hidden = !e.document.getFlag(\"healthEstimate\", \"hideName\");\n\te.document.setFlag(\"healthEstimate\", \"hideName\", hidden)\n\tif (hidden) ui.notifications.info(`${e.actor.data.name}'s name is hidden from players.`);\n\telse ui.notifications.info(`${e.actor.data.name}'s name is shown to players.`);\n}","folder":"ZHrGV0uxoDuYnV0i","sort":125000,"flags":{"core":{"sourceId":"Macro.f1dST0uSVk2pCby1"}},"ownership":{"default":0,"7FLOSVa6De7MrSry":3},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1678115529569,"modifiedTime":1678115529619,"lastModifiedBy":"7FLOSVa6De7MrSry"},"_id":"aHwemKIR2VndWgNw"}
{"name":"Иницитива для всех","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/svg/d20-highlight.svg","scope":"global","command":"/**\n * Берет все выбранные токены и добавляет их в боевой трекер. Затем бросает инициативу для всех токенов NPC и игроков.\n */\nasync function main() {\n await canvas.tokens.toggleCombat();\n  game.combat.rollNPC({ messageOptions: { rollMode: CONST.DICE_ROLL_MODES.PRIVATE }})\ngame.combat.rollAll()\n}\nmain();","flags":{"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.fSyGEAXUVN12sTo1"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672486312944,"modifiedTime":1678115358562,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Pz08NbrXltlABR9O","sort":200000,"ownership":{"default":0,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"e5g7V5e1GTRGUbzy"}
{"name":"Удаление выбранных эффектов","type":"script","scope":"global","author":"7FLOSVa6De7MrSry","img":"icons/magic/control/buff-luck-fortune-clover-green.webp","command":"// Макрос для Foundry, который позволяет удалить выбранные эффекты с токена. \nconst tokenActor = token?.actor ?? game.user.character;\nconst effects = tokenActor.effects.filter(i => i.isTemporary).reduce((acc, e) => acc += `\n  <div class=\"form-group\">\n    <label for=\"${e.id}\">${e.label}</label>\n    <div class=\"form-fields\"><input type=\"checkbox\" id=\"${e.id}\" /></div>\n  </div><hr>`, ``);\nconst content = `<form>${effects}</form>`;\nconst title = \"Delete effects\";\nconst buttons = {del: {\n  icon: `<i class=\"fas fa-check\"></i>`,\n  label: \"Delete!\",\n  callback: async (html) => {\n    const selected = html[0].querySelectorAll(\"input[type=checkbox]:checked\");\n    const deleteIds = [];\n    for(let s of selected) deleteIds.push(s.id);\n    await tokenActor.deleteEmbeddedDocuments(\"ActiveEffect\", deleteIds);\n  }\n}};\nnew Dialog({content, title, buttons, default: \"del\"}).render(true);","flags":{"core":{"sourceId":"Macro.vnS8BMuJ9OUe7B63"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672482677160,"modifiedTime":1678115466562,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Pz08NbrXltlABR9O","sort":300000,"ownership":{"default":0,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"eJjWs9p9GIFXHjqx"}
{"name":"Проверка Проницательности","type":"script","author":"7FLOSVa6De7MrSry","img":"https://i.imgur.com/0xfQUUi.png","scope":"global","command":"//Проверка навыка. \n// Если у игрока несколько персонажей, необходимо выделить тот токен, за которого будет бросаться проверка.\nactor.rollSkill('ins');","flags":{"advanced-macros":{"runAsGM":false},"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.fSyGEAXUVN12sTo1"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672486763863,"modifiedTime":1678115543753,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":100391,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"gadqjGCcUS676z8O"}
{"name":"Hide Estimate","type":"script","flags":{"core":{"sourceId":"Macro.f1dST0uSVk2pCby1"}},"scope":"global","command":"/**\n*  This macro will hide the Health Estimate from selected tokens.\n*/\n\nfor (let e of canvas.tokens.controlled) {\n\tlet hidden = !e.document.getFlag(\"healthEstimate\", \"hideHealthEstimate\");\n\te.document.setFlag(\"healthEstimate\", \"hideHealthEstimate\", hidden)\n\tif (hidden) ui.notifications.info(`${e.actor.data.name}'s health estimate is hidden from players.`);\n\telse ui.notifications.info(`${e.actor.data.name}'s health estimate is shown to players.`);\n}","author":"7FLOSVa6De7MrSry","img":"icons/svg/cowled.svg","ownership":{"default":0,"7FLOSVa6De7MrSry":3},"folder":"ZHrGV0uxoDuYnV0i","sort":200000,"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1678115523626,"modifiedTime":1678115523676,"lastModifiedBy":"7FLOSVa6De7MrSry"},"_id":"jGfIcaVgUGPwiVUc"}
{"name":"Удалить все шаблоны","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/magic/fire/barrier-wall-flame-ring-yellow.webp","scope":"global","command":"// Макрос для Foundry, который позволяет удалить все шаблоны (например от заклинаний) на сцене. \nlet templates = canvas.templates.placeables.map(i=> i.id);\nawait canvas.scene.deleteEmbeddedDocuments(\"MeasuredTemplate\", templates);","flags":{"core":{"sourceId":"Compendium.foundry_community_macros.community-macros-misc.cbvoXlwrSGOFFybV"},"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672485470192,"modifiedTime":1678115472842,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Pz08NbrXltlABR9O","sort":250000,"ownership":{"default":0,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"r7pGMlzFnOnnrFUG"}
{"name":"Свет","type":"script","author":"7FLOSVa6De7MrSry","img":"icons/sundries/lights/lantern-iron-lit-yellow.webp","scope":"global","command":"// Макрос для Foundry, который позволяет пользователю настраивать параметры освещения своего токена. \nfunction tokenUpdate(data) {\n  canvas.tokens.controlled.map(token => token.document.update({light: data}));\n}\n\nlet torchAnimation = {\"type\": \"torch\", \"speed\": 1, \"intensity\": 1, \"reverse\": false};\n\nlet dialogEditor = new Dialog({\n  title: `Светильник для токена`,\n  content: `Выберите источник света для этого токена.`,\n  buttons: {\n    none: {\n      label: `Отключить`,\n      callback: () => {\n        tokenUpdate({\"dim\": 0, \"bright\": 0, \"angle\": 360, \"luminosity\": 0.5});\n        dialogEditor.render(true);\n      }\n    },\n    torch: {\n      label: `Факел`,\n      callback: () => {\n        tokenUpdate({\"dim\": 40, \"bright\": 20, \"angle\": 360, \"luminosity\": 0.5, \"animation\": torchAnimation});\n        dialogEditor.render(true);\n      }\n    },\n    light: {\n      label: `Фокус Свет`,\n      callback: () => {\n        tokenUpdate({\"dim\": 40, \"bright\": 20, \"angle\": 360, \"luminosity\": 0.5, \"animation\": {\"type\": \"none\"}});\n        dialogEditor.render(true);\n      }\n    },\n    lamp: {\n      label: `Лампа`,\n      callback: () => {\n        tokenUpdate({\"dim\": 45, \"bright\": 15, \"angle\": 360, \"luminosity\": 0.5, \"animation\": torchAnimation});\n        dialogEditor.render(true);\n      }\n    },\n    bullseye: {\n      label: `Потайной фонарь`,\n      callback: () => {\n        tokenUpdate({\"dim\": 120, \"bright\": 60, \"angle\": 45, \"luminosity\": 0.5, \"animation\": torchAnimation});\n        dialogEditor.render(true);\n      }\n    },\n    hoodedOpen: {\n      label: `Обычный фонарь (Открыт)`,\n      callback: () => {\n        tokenUpdate({\"dim\": 60, \"bright\": 30, \"angle\": 360, \"luminosity\": 0.5, \"animation\": torchAnimation});\n        dialogEditor.render(true);\n      }\n    },\n    hoodedClosed: {\n      label: `Обычный фонарь (Приглушен)`,\n      callback: () => {\n        tokenUpdate({\"dim\": 5, \"bright\": 0, \"angle\": 360, \"luminosity\": 0.5, \"animation\": torchAnimation});\n        dialogEditor.render(true);\n      }\n    },\n    darkness: {\n      label: `Заклинание Тьма`,\n      callback: () => {\n        tokenUpdate({\"dim\": 0, \"bright\": 15, \"angle\": 360, \"luminosity\": -0.5, \"animation\": {\"type\": \"none\"}});\n        dialogEditor.render(true);\n      }\n    },\n    \n  },\n  default: \"close\",\n  close: () => {}\n});\n\ndialogEditor.render(true)","flags":{"exportSource":{"world":"novaya-sistema","system":"dnd5e","coreVersion":"9.280","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.zTQcAR35R2r30R50"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672483553775,"modifiedTime":1678115543751,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":150000,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"tqtSjK5vtml2c24T"}
{"name":"Заявка","type":"script","scope":"global","author":"7FLOSVa6De7MrSry","img":"icons/skills/social/wave-halt-stop.webp","command":"// Макрос для Foundry, который позволяет пользователю вывести в чат сообщение о заявке. Спасибо Elfrey и Salamander\n// Макрос для Foundry, который позволяет пользователю вывести в чат сообщение о заявке. Спасибо Elfrey и Salamander\nAudioHelper.play({src: 'https://raw.githubusercontent.com/laaruk/journal/main/bell.ogg', volume: 1, autoplay: true, loop: false}, true);\n\nconst text = '<h1 style=\"text-align: center;\"><span style=\"font-size:36px;\"><span style=\"color:#8000ff;\">Заявка</strong></h1><img src=\"icons/skills/social/wave-halt-stop.webp\" width=\"350\">'\n\nChatMessage.create({\nuser: game.user._id,\nspeaker: ChatMessage.getSpeaker({token: actor}),\ncontent: text\n});","flags":{"core":{"sourceId":"Macro.PtMGtNubVSLEDRL0"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672482311656,"modifiedTime":1678115543751,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":200000,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"u9gzl2DBkaChcd1A"}
{"name":"Mark Dead","type":"script","flags":{"core":{"sourceId":"Macro.bCMlVEb7wx14ACIB"}},"scope":"global","command":"/**\n*  This macro will mark the selected tokens as dead.\n*  If all the selected tokens are dead, they will be marked\n   as alive instead.\n*/\n\nfor (let e of canvas.tokens.controlled) {\n\tlet hasAlive = !e.document.getFlag(\"healthEstimate\", \"dead\")\n\te.document.setFlag(\"healthEstimate\", \"dead\", hasAlive)\n}","author":"7FLOSVa6De7MrSry","img":"icons/svg/bones.svg","ownership":{"default":0,"7FLOSVa6De7MrSry":3},"folder":"ZHrGV0uxoDuYnV0i","sort":150000,"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1678115526376,"modifiedTime":1678115526425,"lastModifiedBy":"7FLOSVa6De7MrSry"},"_id":"wNRvVWQDuqkBHj8F"}
{"name":"Конец хода","type":"script","scope":"global","author":"7FLOSVa6De7MrSry","img":"icons/skills/melee/weapons-crossed-daggers-orange.webp","command":"/*\nAuthor: willisrocks\nDescription: \n\nЗавершает текущий ход актеров боевым столкновением. Полезно, когда вы не используете свой боевой трекер. и хотите закончить ход с панели быстрого доступа. Если пользователь является гейм-мастером, он всегда будет завершать текущий ход. \nДля игроков это только закончится ход, когда текущий актер в порядке хода принадлежит вам. На основе работы пользователя Reddit serrag97: https://www.reddit.com/r/FoundryVTT/comments/j1b8gs/next_turn_shortcut/\n*/\n\n// check if the user is a GM\nconst isGM = game.user.isGM;\n// check if the user owns the combatant whose turn it is\nconst isOwner = game.combat.combatant.isOwner;\n\nif (isGM || isOwner) {\n  game.combat.nextTurn();\n} else {\n  ui.notifications.info(\"Как игрок вы можете только продвигать свой ход\");\n}","flags":{"core":{"sourceId":"Macro.2hjDVnk5dbuCSuH6"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672482529405,"modifiedTime":1678115543753,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":103125,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"yXmDGgeioJwKrx2x"}
{"name":"Проверка Внимания","type":"script","author":"7FLOSVa6De7MrSry","img":"https://i.imgur.com/jOQlpmI.png","scope":"global","command":"//Проверка навыка. \n// Если у игрока несколько персонажей, необходимо выделить тот токен, за которого будет бросаться проверка.\nactor.rollSkill('prc');","flags":{"advanced-macros":{"runAsGM":false},"exportSource":{"world":"avernus","system":"dnd5e","coreVersion":"9.269","systemVersion":"1.6.3"},"core":{"sourceId":"Macro.fSyGEAXUVN12sTo1"}},"_stats":{"systemId":"dnd5e","systemVersion":"2.1.5","coreVersion":"10.291","createdTime":1672486954303,"modifiedTime":1678115543753,"lastModifiedBy":"7FLOSVa6De7MrSry"},"folder":"Ro21mwVVlgn3Oi16","sort":100782,"ownership":{"default":2,"ekSJaSkR4p1sowmM":3,"7FLOSVa6De7MrSry":3},"_id":"ydCrvDE27HKoT9jo"}
